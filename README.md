
# OpenShift UPI Deployment (vSphere + Custom Networking)

This project automates the deployment of a Red Hat OpenShift 4.16 UPI (User Provisioned Infrastructure) cluster on a vSphere environment with custom DHCP/static IP workflows and node labeling.

---

## 🗂️ Project Structure

```
.
├── clusters/
│   └── test.yaml                 # Main YAML file defining cluster parameters
├── install-configs/
│   └── test/                     # Generated by script (includes ignition files)
├── scripts/                      # All automation scripts
│   ├── cleanup-bootstrap.sh
│   ├── deploy-vms.sh
│   ├── fix-cloud-provider-taints.sh
│   ├── generate-console-password-manifests.sh
│   ├── generate-core-user-password.sh
│   ├── generate-install-config.sh
│   ├── generate-vsphere-creds-manifest.sh
│   ├── label-nodes.sh
│   ├── load-vcenter-env.sh
│   └── rebuild-cluster.sh
```

---

## 🚀 End-to-End Cluster Rebuild

The single entry point for a full install is:

```bash
./scripts/rebuild-cluster.sh clusters/test.yaml
```

This script will:
1. Load vCenter credentials from your environment
2. Generate `install-config.yaml` from the YAML input
3. Run `openshift-install` to produce manifests and ignition files
4. Patch manifests with vSphere credentials
5. Clone and configure bootstrap, master, and worker VMs via `govc`
6. Monitor bootstrap progress until completion
7. Delete the bootstrap VM
8. Apply taint fixes and node labels (read from YAML)

---

## 🧩 Required Inputs in Cluster YAML

Sample `clusters/test.yaml` includes:

- vSphere info: server, datacenter, cluster, network, etc.
- Pull secret path and SSH key path
- Node counts and static IP definitions
- Optional: Node labels

Example YAML snippet for labels:
```yaml
node_labels:
  master:
    cluster-role: master
    node-type: control-plane
  worker:
    cluster-role: worker
    workload: general
```

---

## 🔐 Credentials

Be sure to export vCenter credentials into your shell session before running:

```bash
export GOVC_URL='vcenter1.domain.local'
export GOVC_USERNAME='administrator@vsphere.local'
export GOVC_PASSWORD='your-password'
```

Alternatively, edit and source `scripts/load-vcenter-env.sh`.

---

## 🛠️ Individual Scripts (Advanced Use)

| Script                            | Description |
|-----------------------------------|-------------|
| `generate-install-config.sh`      | Generates `install-config.yaml` dynamically from YAML |
| `generate-vsphere-creds-manifest.sh` | Adds vSphere creds to manifests |
| `deploy-vms.sh`                   | Deploys VMs using `govc` with DHCP/static hybrid |
| `cleanup-bootstrap.sh`            | Removes bootstrap VM post-install |
| `fix-cloud-provider-taints.sh`    | Removes cloud provider taints from master nodes |
| `label-nodes.sh`                  | Dynamically labels nodes using `oc label` |
| `generate-console-password-manifests.sh` | Adds console credentials (optional) |
| `generate-core-user-password.sh`  | Adds core user password manifest (optional) |

---

## 🧪 Tested Environment

- **vSphere**: 7.x+ with accessible DHCP
- **OpenShift Installer**: 4.16
- **DNS**: Forward/reverse records required
- **Load Balancer**: HAProxy or equivalent recommended

---

## 🧼 Cleanup

To delete a cluster, remove the corresponding VM folder in vCenter and delete the install directory:

```bash
rm -rf install-configs/test
# Delete VMs manually or with a future automation script
```

---

## 📌 Notes

- Ensure all DNS entries are configured before install (API, Ingress, etc.)
- Make sure your DHCP server is properly reserving the correct IPs for bootstrap and masters
- This setup assumes hybrid IP bootstrapping (DHCP → static via MachineConfig)

---

## 🎉 Credits

Built and tested by Steve Boyle for home lab OpenShift experimentation.
