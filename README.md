
# OpenShift UPI Deployment (vSphere + Custom Networking)

This project automates the deployment of a Red Hat OpenShift 4.16 UPI (User Provisioned Infrastructure) cluster on a vSphere environment with custom DHCP/static IP workflows and node labeling.

---

## ğŸ—‚ï¸ Project Structure

```
.
â”œâ”€â”€ clusters/
â”‚   â””â”€â”€ test.yaml                 # Main YAML file defining cluster parameters
â”œâ”€â”€ install-configs/
â”‚   â””â”€â”€ test/                     # Generated by script (includes ignition files)
â”œâ”€â”€ scripts/                      # All automation scripts
â”‚   â”œâ”€â”€ cleanup-bootstrap.sh
â”‚   â”œâ”€â”€ deploy-vms.sh
â”‚   â”œâ”€â”€ fix-cloud-provider-taints.sh
â”‚   â”œâ”€â”€ generate-console-password-manifests.sh
â”‚   â”œâ”€â”€ generate-core-user-password.sh
â”‚   â”œâ”€â”€ generate-install-config.sh
â”‚   â”œâ”€â”€ generate-vsphere-creds-manifest.sh
â”‚   â”œâ”€â”€ label-nodes.sh
â”‚   â”œâ”€â”€ load-vcenter-env.sh
â”‚   â””â”€â”€ rebuild-cluster.sh
```

---

## ğŸš€ End-to-End Cluster Rebuild

The single entry point for a full install is:

```bash
./scripts/rebuild-cluster.sh clusters/test.yaml
```

This script will:
1. Load vCenter credentials from your environment
2. Generate `install-config.yaml` from the YAML input
3. Run `openshift-install` to produce manifests and ignition files
4. Patch manifests with vSphere credentials
5. Clone and configure bootstrap, master, and worker VMs via `govc`
6. Monitor bootstrap progress until completion
7. Delete the bootstrap VM
8. Apply taint fixes and node labels (read from YAML)

---

## ğŸ§© Required Inputs in Cluster YAML

Sample `clusters/test.yaml` includes:

- vSphere info: server, datacenter, cluster, network, etc.
- Pull secret path and SSH key path
- Node counts and static IP definitions
- Optional: Node labels

Example YAML snippet for labels:
```yaml
node_labels:
  master:
    cluster-role: master
    node-type: control-plane
  worker:
    cluster-role: worker
    workload: general
```

---

## ğŸ” Credentials

Be sure to export vCenter credentials into your shell session before running:

```bash
export GOVC_URL='vcenter1.domain.local'
export GOVC_USERNAME='administrator@vsphere.local'
export GOVC_PASSWORD='your-password'
```

Alternatively, edit and source `scripts/load-vcenter-env.sh`.

---

## ğŸ› ï¸ Individual Scripts (Advanced Use)

| Script                            | Description |
|-----------------------------------|-------------|
| `generate-install-config.sh`      | Generates `install-config.yaml` dynamically from YAML |
| `generate-vsphere-creds-manifest.sh` | Adds vSphere creds to manifests |
| `deploy-vms.sh`                   | Deploys VMs using `govc` with DHCP/static hybrid |
| `cleanup-bootstrap.sh`            | Removes bootstrap VM post-install |
| `fix-cloud-provider-taints.sh`    | Removes cloud provider taints from master nodes |
| `label-nodes.sh`                  | Dynamically labels nodes using `oc label` |
| `generate-console-password-manifests.sh` | Adds console credentials (optional) |
| `generate-core-user-password.sh`  | Adds core user password manifest (optional) |

---

## ğŸ§ª Tested Environment

- **vSphere**: 7.x+ with accessible DHCP
- **OpenShift Installer**: 4.16
- **DNS**: Forward/reverse records required
- **Load Balancer**: HAProxy or equivalent recommended

---

## ğŸ§¼ Cleanup

To delete a cluster, remove the corresponding VM folder in vCenter and delete the install directory:

```bash
rm -rf install-configs/test
# Delete VMs manually or with a future automation script
```

---

## ğŸ“Œ Notes

- Ensure all DNS entries are configured before install (API, Ingress, etc.)
- Make sure your DHCP server is properly reserving the correct IPs for bootstrap and masters
- This setup assumes hybrid IP bootstrapping (DHCP â†’ static via MachineConfig)

---

## ğŸ‰ Credits

Built and tested by Steve Boyle for home lab OpenShift experimentation.
